<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Exam - COE Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .form-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-section h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .resource-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }
        
        .resource-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .resource-box h3 {
            margin-bottom: 15px;
            color: #4CAF50;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        
        .checkbox-item:hover {
            background-color: #f5f5f5;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            flex: 1;
        }
        
        .select-all-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .select-all-btn:hover {
            background: #0b7dda;
        }
        
        .submit-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            background: #45a049;
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .back-btn {
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: #555;
        }
        
        .error-message {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-message {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
            font-style: italic;
        }
        
        .student-counter {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .student-counter h4 {
            margin: 0 0 10px 0;
            color: #1976D2;
            font-size: 16px;
        }
        
        .student-count {
            font-size: 28px;
            font-weight: bold;
            color: #1565C0;
        }
        
        .student-counter.complete {
            background: #c8e6c9;
            border-color: #4CAF50;
        }
        
        .student-counter.complete h4 {
            color: #2E7D32;
        }
        
        .student-counter.complete .student-count {
            color: #1B5E20;
        }
        
        .capacity-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/coe/dashboard" class="back-btn">← Back to Dashboard</a>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <form id="scheduleForm">
            <!-- Exam Details Section -->
            <div class="form-section">
                <h2>Exam Details</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Academic Year *</label>
                        <input type="text" id="academicYear" name="academicYear" 
                               placeholder="e.g., 2024-2025" required>
                        <span class="info-text">Format: YYYY-YYYY</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Type *</label>
                        <select id="examType" name="examType" required>
                            <option value="">Select Exam Type</option>
                            <option value="Internal1">Internal 1</option>
                            <option value="Internal2">Internal 2</option>
                            <option value="SEM">Semester End Exam (SEM)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Year *</label>
                        <select id="year" name="year" required>
                            <option value="">Select Year</option>
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                            <option value="4">Year 4</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Semester *</label>
                        <select id="semester" name="semester" required>
                            <option value="">Select Semester</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="sessionGroup" style="display: none;">
                        <label>Session</label>
                        <select id="session" name="session">
                            <option value="">Not Applicable</option>
                            <option value="FN">Forenoon (FN)</option>
                            <option value="AN">Afternoon (AN)</option>
                        </select>
                        <span class="info-text">Only for SEM exams</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="startDate" name="startDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="endDate" name="endDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Holidays (comma-separated)</label>
                        <input type="text" id="holidays" name="holidays" 
                               placeholder="e.g., 2025-01-26, 2025-02-15">
                        <span class="info-text">Format: YYYY-MM-DD</span>
                    </div>
                </div>
            </div>
            
            <!-- Resource Selection Section -->
            <div class="form-section">
                <h2>Resource Selection</h2>
                <div class="resource-selection">
                    <!-- Faculty Selection -->
                    <div class="resource-box">
                        <h3>Select Faculty</h3>
                        <button type="button" class="select-all-btn" onclick="toggleSelectAll('faculty')">
                            Select All Faculty
                        </button>
                        <div id="facultyList">
                            <p>Loading faculty...</p>
                        </div>
                    </div>
                    
                    <!-- Hall Selection -->
                    <div class="resource-box">
                        <h3>Select Halls</h3>
                        <div id="studentCounter" class="student-counter" style="display: none;">
                            <h4>Students Remaining to Allocate</h4>
                            <div class="student-count" id="remainingStudents">0</div>
                            <div class="capacity-info" id="capacityInfo">Select a year to see student count</div>
                        </div>
                        <button type="button" class="select-all-btn" onclick="toggleSelectAll('halls')">
                            Select All Halls
                        </button>
                        <div id="hallsList">
                            <p>Loading halls...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="submit-btn">Generate Schedule & Seating</button>
        </form>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Generating Schedule...</h3>
            <p>This may take a few moments. Please wait.</p>
        </div>
    </div>
    
    <script>
        let hallsData = [];
        let totalStudents = 0;
        
        // Load faculty and halls on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadFaculty();
            await loadHalls();
        });
        
        // Listen for year and semester selection to fetch student count
        document.getElementById('year').addEventListener('change', fetchStudentCountIfReady);
        document.getElementById('semester').addEventListener('change', fetchStudentCountIfReady);
        
        async function fetchStudentCountIfReady() {
            const year = document.getElementById('year').value;
            const semester = document.getElementById('semester').value;
            
            if (year && semester) {
                await fetchStudentCount(year, semester);
            } else {
                document.getElementById('studentCounter').style.display = 'none';
            }
        }
        
        // Fetch student count for selected year and semester
        async function fetchStudentCount(year, semester) {
            try {
                const response = await fetch(`/api/coe/students/count?year=${year}&semester=${semester}`);
                const data = await response.json();
                
                totalStudents = data.count || 0;
                document.getElementById('remainingStudents').textContent = totalStudents;
                document.getElementById('capacityInfo').textContent = `Total students in Year ${year}, Semester ${semester}: ${totalStudents}`;
                document.getElementById('studentCounter').style.display = 'block';
                document.getElementById('studentCounter').classList.remove('complete');
                
                // Reset all hall selections when year/semester changes
                document.querySelectorAll('input[name="halls"]:checked').forEach(cb => cb.checked = false);
                updateStudentCount();
            } catch (error) {
                console.error('Error fetching student count:', error);
                totalStudents = 0;
                document.getElementById('remainingStudents').textContent = '0';
                document.getElementById('capacityInfo').textContent = 'Error loading student count';
            }
        }
        
        // Update student count based on selected halls
        function updateStudentCount() {
            const selectedHalls = Array.from(document.querySelectorAll('input[name="halls"]:checked'));
            const examType = document.getElementById('examType').value;
            
            let totalCapacity = 0;
            selectedHalls.forEach(checkbox => {
                const hallId = checkbox.value;
                const hall = hallsData.find(h => h._id === hallId);
                if (hall) {
                    // For Internal exams: 2 students per bench
                    // For SEM: 1 student per bench
                    const multiplier = (examType === 'Internal1' || examType === 'Internal2') ? 2 : 1;
                    totalCapacity += hall.capacity * multiplier;
                }
            });
            
            const remaining = Math.max(0, totalStudents - totalCapacity);
            document.getElementById('remainingStudents').textContent = remaining;
            
            const counter = document.getElementById('studentCounter');
            if (remaining === 0 && totalStudents > 0) {
                counter.classList.add('complete');
                document.getElementById('capacityInfo').textContent = `✓ All ${totalStudents} students can be accommodated`;
            } else {
                counter.classList.remove('complete');
                document.getElementById('capacityInfo').textContent = 
                    `Selected capacity: ${totalCapacity} | Total students: ${totalStudents}`;
            }
        }
        
        // Show/hide session field based on exam type
        document.getElementById('examType').addEventListener('change', (e) => {
            const sessionGroup = document.getElementById('sessionGroup');
            const sessionSelect = document.getElementById('session');
            
            if (e.target.value === 'SEM') {
                sessionGroup.style.display = 'block';
                sessionSelect.required = true;
            } else {
                sessionGroup.style.display = 'none';
                sessionSelect.required = false;
                sessionSelect.value = '';
            }
            
            // Update capacity calculation when exam type changes
            updateStudentCount();
        });
        
        async function loadFaculty() {
            try {
                const response = await fetch('/api/coe/faculty');
                const faculty = await response.json();
                
                const facultyList = document.getElementById('facultyList');
                facultyList.innerHTML = faculty.map(f => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="faculty_${f._id}" name="faculty" value="${f._id}">
                        <label for="faculty_${f._id}">
                            ${f.name} (${f.employeeId}) - ${f.department.name}
                        </label>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading faculty:', error);
                document.getElementById('facultyList').innerHTML = 
                    '<p style="color: red;">Error loading faculty</p>';
            }
        }
        
        async function loadHalls() {
            try {
                const response = await fetch('/api/coe/halls');
                const halls = await response.json();
                hallsData = halls; // Store for capacity calculations
                
                const hallsList = document.getElementById('hallsList');
                hallsList.innerHTML = halls.map(h => `
                    <div class="checkbox-item">
                        <input type="checkbox" id="hall_${h._id}" name="halls" value="${h._id}" 
                               onchange="updateStudentCount()">
                        <label for="hall_${h._id}">
                            ${h.hallNumber} - Capacity: ${h.capacity} benches (${h.columns} columns)
                        </label>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading halls:', error);
                document.getElementById('hallsList').innerHTML = 
                    '<p style="color: red;">Error loading halls</p>';
            }
        }
        
        function toggleSelectAll(type) {
            const checkboxes = document.querySelectorAll(`input[name="${type}"]`);
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }
        
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(e.target);
            const selectedFaculty = Array.from(document.querySelectorAll('input[name="faculty"]:checked'))
                .map(cb => cb.value);
            const selectedHalls = Array.from(document.querySelectorAll('input[name="halls"]:checked'))
                .map(cb => cb.value);
            
            // Validation
            if (selectedFaculty.length === 0) {
                showError('Please select at least one faculty member');
                return;
            }
            
            if (selectedHalls.length === 0) {
                showError('Please select at least one hall');
                return;
            }
            
            const data = {
                academicYear: formData.get('academicYear'),
                semester: parseInt(formData.get('semester')),
                examType: formData.get('examType'),
                year: parseInt(formData.get('year')),
                session: formData.get('session') || null,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                holidays: formData.get('holidays') ? 
                    formData.get('holidays').split(',').map(d => d.trim()) : [],
                selectedFaculty,
                selectedHalls
            };
            
            console.log('Submitting data:', data);
            
            try {
                showLoading();
                
                const response = await fetch('/api/coe/schedule-exam', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                hideLoading();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to generate schedule');
                }
                
                showSuccess('Schedule generated successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = `/coe/view-schedule/${result.scheduleId}`;
                }, 2000);
                
            } catch (error) {
                hideLoading();
                showError(error.message);
            }
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }
        
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
